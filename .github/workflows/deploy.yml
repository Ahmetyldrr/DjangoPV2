name: Deploy to Production

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5


    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install Django psycopg2-binary requests django-allauth PyJWT cryptography oauthlib requests-oauthlib python3-openid
        pip install django-csp channels channels-redis redis celery whitenoise markdown Pillow gunicorn
        pip install -r requirements.txt || true
    
    - name: Run tests
      env:
        DATABASE_URL: postgres://postgres:postgres@localhost/test_db
        REDIS_URL: redis://localhost:6379/0
      run: |
        python manage.py check
        python manage.py test

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: 165.227.130.23
        username: root
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /var/www/apphane
          
          # Git güncellemesi
          git stash
          git pull origin main
          
          # Nginx-uyumlu Docker Compose kullan (port 9000:9000)
          cp docker-compose-simple.yml docker-compose.yml
          
          # Graceful shutdown (Nginx'i etkilemez)
          docker-compose down --timeout 30 || true
          
          # Clean up any hanging containers
          docker container prune -f || true
          
          # Cache temizliği (sorun olursa)
          docker system prune -f || true
          
          # Clean build with more logging
          echo "🔨 Building Django web container..."
          docker-compose build --no-cache web
          
          # Install new dependencies if any
          echo "📦 Installing dependencies..."
          docker-compose run --rm web pip install -r requirements.txt || true
          
          # Start services with verbose logging
          echo "🚀 Starting services..."
          docker-compose up -d
          
          # Wait a bit for containers to stabilize
          echo "⏳ Waiting for containers to start..."
          sleep 15
          
          # Check if containers started successfully
          echo "📊 Container status after startup:"
          docker-compose ps
          
          # Run migrations
          docker-compose exec -T web python manage.py migrate --noinput
          
          # Collect static files
          docker-compose exec -T web python manage.py collectstatic --noinput --clear
          
          # Copy static files to host for Nginx (HTTPS compatibility)
          docker cp apphane_web_1:/app/staticfiles/. /var/www/apphane/staticfiles/ 2>/dev/null || true
          docker cp apphane_web_1:/app/media/. /var/www/apphane/media/ 2>/dev/null || true
          
          # Ensure Nginx is running and configured correctly
          systemctl restart nginx
          systemctl enable nginx
          
          # Wait for services to be fully ready
          echo "⏳ Waiting for services to be ready..."
          sleep 30
          
          # Check if containers are running first
          echo "📊 Checking container status:"
          docker-compose ps
          
          # Check Django container logs if unhealthy
          echo "📋 Django container logs (last 20 lines):"
          docker-compose logs --tail=20 web
          
          # Health check with retry - try internal first, then external
          echo "🔍 Testing Django health check..."
          for i in {1..5}; do
            # First try internal health check
            if docker-compose exec -T web python manage.py check > /dev/null 2>&1; then
              echo "✅ Django management commands working"
              # Then try HTTP health check
              if curl -f http://localhost:9000/health/ > /dev/null 2>&1; then
                echo "✅ Django HTTP endpoint is healthy"
                break
              else
                echo "⚠️ Django management OK but HTTP endpoint not ready"
              fi
            else
              echo "❌ Django management commands failing"
            fi
            
            if [ $i -eq 5 ]; then
              echo "❌ Health check failed after 5 attempts"
              echo "🔍 Debugging info:"
              echo "Container status:"
              docker-compose ps
              echo "Web container logs:"
              docker-compose logs web
              echo "Port check:"
              netstat -tulpn | grep 9000 || echo "Port 9000 not listening"
            else
              echo "⏳ Attempt $i: Waiting for Django backend..."
              sleep 10
            fi
          done
          
          # Test HTTPS site
          if curl -f https://apphane.com.tr/ > /dev/null 2>&1; then
            echo "✅ HTTPS site is working"
          else
            echo "❌ HTTPS site test failed"
          fi
          
          # Debug info if something fails
          echo "📊 Final Status Check:"
          echo "Docker containers:"
          docker-compose ps
          echo "Nginx status:"
          systemctl status nginx --no-pager | head -10
          echo "Port usage:"
          netstat -tulpn | grep -E ':(80|443|9000)' || true
          
          echo "✅ Deployment completed successfully!"
    
          
          echo "✅ Deployment completed successfully!"

  notify:
    needs: [test, deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Notification
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "🚀 Deployment successful!"
          echo "✅ Site: https://apphane.com.tr"
          echo "✅ Admin: https://apphane.com.tr/admin/"
          echo "✅ Apps: https://apphane.com.tr/uygulamalar/"
          echo "🔒 HTTPS SSL enabled"
        else
          echo "❌ Deployment failed!"
          exit 1
        fi
