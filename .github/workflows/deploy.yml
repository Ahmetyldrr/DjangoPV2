name: Deploy to Production

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5


    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install Django psycopg2-binary requests django-allauth PyJWT cryptography oauthlib requests-oauthlib python3-openid
        pip install django-csp django-redis channels channels-redis redis celery whitenoise markdown Pillow gunicorn
        pip install -r requirements.txt || true
    
    - name: Run tests
      env:
        DATABASE_URL: postgres://postgres:postgres@localhost/test_db
        REDIS_URL: redis://localhost:6379/0
      run: |
        python manage.py check
        python manage.py test

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: 165.227.130.23
        username: root
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /var/www/apphane
          
          # Git gÃ¼ncellemesi
          git stash
          git pull origin main
          
          # Nginx-uyumlu Docker Compose kullan (port 9000:9000)
          cp docker-compose-simple.yml docker-compose.yml
          
          # Graceful shutdown (Nginx'i etkilemez)
          docker-compose down --timeout 30
          
          # Cache temizliÄŸi (sorun olursa)
          docker system prune -f
          
          # Clean build
          docker-compose build --no-cache web
          
          # Install new dependencies if any
          docker-compose run --rm web pip install -r requirements.txt
          
          # Start services
          docker-compose up -d
          
          # Run migrations
          docker-compose exec -T web python manage.py migrate --noinput
          
          # Collect static files
          docker-compose exec -T web python manage.py collectstatic --noinput --clear
          
          # Copy static files to host for Nginx (HTTPS compatibility)
          docker cp apphane_web_1:/app/staticfiles/. /var/www/apphane/staticfiles/ 2>/dev/null || true
          docker cp apphane_web_1:/app/media/. /var/www/apphane/media/ 2>/dev/null || true
          
          # Ensure Nginx is running and configured correctly
          systemctl restart nginx
          systemctl enable nginx
          
          # Wait for services to be fully ready
          echo "â³ Waiting for services to be ready..."
          sleep 30
          
          # Health check with retry
          for i in {1..5}; do
            if curl -f http://localhost:9000/health/ > /dev/null 2>&1; then
              echo "âœ… Django backend is healthy"
              break
            else
              echo "â³ Attempt $i: Waiting for Django backend..."
              sleep 10
            fi
          done
          
          # Test HTTPS site
          if curl -f https://apphane.com.tr/ > /dev/null 2>&1; then
            echo "âœ… HTTPS site is working"
          else
            echo "âŒ HTTPS site test failed"
          fi
          
          # Debug info if something fails
          echo "ğŸ“Š Final Status Check:"
          echo "Docker containers:"
          docker-compose ps
          echo "Nginx status:"
          systemctl status nginx --no-pager | head -10
          echo "Port usage:"
          netstat -tulpn | grep -E ':(80|443|9000)' || true
          
          echo "âœ… Deployment completed successfully!"
    
          
          echo "âœ… Deployment completed successfully!"

  notify:
    needs: [test, deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Notification
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "ğŸš€ Deployment successful!"
          echo "âœ… Site: https://apphane.com.tr"
          echo "âœ… Admin: https://apphane.com.tr/admin/"
          echo "âœ… Apps: https://apphane.com.tr/uygulamalar/"
          echo "ğŸ”’ HTTPS SSL enabled"
        else
          echo "âŒ Deployment failed!"
          exit 1
        fi
