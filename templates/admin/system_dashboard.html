{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Sistem Dashboard - Apphane Admin{% endblock %}

{% block extrahead %}
<style>
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }
    .stat-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #0074D9;
    }
    .stat-label {
        color: #666;
        margin-top: 5px;
    }
    .log-container {
        background: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
        max-height: 400px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 12px;
    }
    .log-line {
        margin: 2px 0;
        white-space: pre-wrap;
    }
    .log-error { color: #dc3545; }
    .log-warning { color: #ffc107; }
    .log-success { color: #28a745; }
    .log-info { color: #17a2b8; }
    .btn-test {
        background: #28a745;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
    }
    .btn-test:hover {
        background: #218838;
    }
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    .status-ok { background: #28a745; }
    .status-warning { background: #ffc107; }
    .status-error { background: #dc3545; }
    .refresh-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }
</style>
{% endblock %}

{% block content %}
<h1>🖥️ Sistem Dashboard - Apphane.com.tr</h1>

<div class="dashboard-grid">
    <!-- İstatistikler -->
    <div class="stat-card">
        <h3>📊 24 Saat İstatistikleri</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
                <div class="stat-number">{{ stats.messages_24h }}</div>
                <div class="stat-label">Yeni Mesajlar</div>
            </div>
            <div>
                <div class="stat-number">{{ stats.new_chats_24h }}</div>
                <div class="stat-label">Yeni Chat'ler</div>
            </div>
            <div>
                <div class="stat-number">{{ stats.active_users_24h }}</div>
                <div class="stat-label">Aktif Kullanıcılar</div>
            </div>
            <div>
                <div class="stat-number">{{ stats.total_messages }}</div>
                <div class="stat-label">Toplam Mesaj</div>
            </div>
        </div>
    </div>

    <!-- Email Durumu -->
    <div class="stat-card">
        <h3>📧 Email Sistemi Durumu</h3>
        <div style="margin: 10px 0;">
            <span class="status-indicator {% if email_settings.notifications_enabled %}status-ok{% else %}status-warning{% endif %}"></span>
            <strong>Bildirimler:</strong> {% if email_settings.notifications_enabled %}Aktif{% else %}Pasif{% endif %}
        </div>
        <div style="margin: 10px 0;">
            <span class="status-indicator {% if email_settings.backend == 'django.core.mail.backends.smtp.EmailBackend' %}status-ok{% else %}status-warning{% endif %}"></span>
            <strong>Backend:</strong> {{ email_settings.backend|slice:":30" }}...
        </div>
        <div style="margin: 10px 0;">
            <span class="status-indicator {% if email_settings.admin_emails %}status-ok{% else %}status-error{% endif %}"></span>
            <strong>Admin Email'ler:</strong> {{ email_settings.admin_emails|length }} adet
        </div>
        <div style="margin: 15px 0;">
            <button class="btn-test" onclick="testEmail('basic')">🧪 Test Email</button>
            <button class="btn-test" onclick="testEmail('notification')">🔔 Test Bildirim</button>
        </div>
        <div id="test-result" style="margin-top: 10px;"></div>
    </div>

    <!-- Son Mesajlar -->
    <div class="stat-card">
        <h3>💬 Son Mesajlar</h3>
        <div style="max-height: 300px; overflow-y: auto;">
            {% for message in recent_messages %}
            <div style="border-bottom: 1px solid #eee; padding: 8px 0;">
                <strong>{{ message.sender.get_full_name }}</strong>
                <small style="color: #666;">({{ message.created_at|date:"d/m/Y H:i" }})</small>
                <div style="color: #333; margin-top: 3px;">
                    {{ message.content|truncatewords:10 }}
                </div>
            </div>
            {% empty %}
            <p>Henüz mesaj yok</p>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Log Görüntüleme -->
<div class="stat-card" style="margin-top: 20px;">
    <h3>📋 Sistem Logları 
        <button class="refresh-btn" onclick="refreshLogs('email')">Email Logs</button>
        <button class="refresh-btn" onclick="refreshLogs('django')">Django Logs</button>
        <button class="refresh-btn" onclick="refreshLogs('email')">🔄 Yenile</button>
    </h3>
    
    <div id="log-container" class="log-container">
        <div class="log-line log-info">Logları görüntülemek için yukarıdaki butonlara tıklayın...</div>
    </div>
</div>

<script>
function testEmail(testType) {
    const resultDiv = document.getElementById('test-result');
    resultDiv.innerHTML = '<div style="color: #007bff;">🔄 Test ediliyor...</div>';
    
    const formData = new FormData();
    formData.append('test_type', testType);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch('{% url "admin_test_email" %}', {
        method: 'POST',
        body: formData,
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultDiv.innerHTML = `<div style="color: #28a745;">✅ ${data.message}</div>`;
        } else {
            resultDiv.innerHTML = `<div style="color: #dc3545;">❌ ${data.error}</div>`;
        }
        
        // 3 saniye sonra logları yenile
        setTimeout(() => {
            refreshLogs('email');
        }, 3000);
    })
    .catch(error => {
        resultDiv.innerHTML = `<div style="color: #dc3545;">❌ Hata: ${error}</div>`;
    });
}

function refreshLogs(logType) {
    const container = document.getElementById('log-container');
    container.innerHTML = '<div class="log-line log-info">🔄 Loglar yükleniyor...</div>';
    
    fetch(`{% url "admin_api_logs" %}?type=${logType}&tail=50`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            container.innerHTML = '';
            data.logs.forEach(line => {
                const div = document.createElement('div');
                div.className = 'log-line';
                
                // Log seviyesine göre class ekle
                if (line.includes('ERROR')) {
                    div.className += ' log-error';
                } else if (line.includes('WARNING')) {
                    div.className += ' log-warning';
                } else if (line.includes('SUCCESS') || line.includes('✅')) {
                    div.className += ' log-success';
                } else if (line.includes('INFO')) {
                    div.className += ' log-info';
                }
                
                div.textContent = line;
                container.appendChild(div);
            });
            
            // En alta scroll et
            container.scrollTop = container.scrollHeight;
            
            // Başlığı güncelle
            document.querySelector('#log-container').previousElementSibling.innerHTML = 
                `📋 ${logType.toUpperCase()} Logları (${data.total_lines} toplam satır)
                <button class="refresh-btn" onclick="refreshLogs('email')">Email Logs</button>
                <button class="refresh-btn" onclick="refreshLogs('django')">Django Logs</button>
                <button class="refresh-btn" onclick="refreshLogs('${logType}')">🔄 Yenile</button>`;
        } else {
            container.innerHTML = `<div class="log-line log-error">❌ ${data.error}</div>`;
        }
    })
    .catch(error => {
        container.innerHTML = `<div class="log-line log-error">❌ API Hatası: ${error}</div>`;
    });
}

// 30 saniyede bir otomatik yenile
setInterval(() => {
    refreshLogs('email');
}, 30000);

// Sayfa yüklendiğinde email loglarını göster
document.addEventListener('DOMContentLoaded', () => {
    refreshLogs('email');
});
</script>

{% csrf_token %}
{% endblock %}
